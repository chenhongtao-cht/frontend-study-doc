---
layout: doc
---

## 2024 年 6 月 3 日

[参考地址-前端监控](https://cloud.tencent.com/developer/article/1983779)
## 前端监控

#### 1. 什么是前端监控
> 在前端工程注入监控代码，通过**页面监控、页面设置**埋点上报数据，来获取**用户信息、异常信息、行为交互信息**等，
在后台系统能够展示快速定位问题的信息，或者针对每种系统的业务场景做数据分析，数据整合；以达到实时监察系统的运行状态、
快速响应系统问题、提升系统的用户体验的目的。

#### 2. 出现的背景

+ 开发人员需要实时监测系统运行状态，集中处理问题，降低沟通成本。
+ 收集用户数据，帮助产品迭代升级。
+ 产品针对于每个用户需要出现定制化的需求，提升用户使用体验。

#### 3. 前端监控需要监控什么

1.  **稳定性 stability**
+ js错误：js执行错误、promise异常
+ 资源错误：js、css资源加载异常
+ 接口错误：ajax、fetch请求接口异常
+ 白屏：页面空白

2.  **用户体验 experience**

3.  **业务 business**
+ pv：页面浏览量和点击量
+ uv：访问某个站点的不同ip的人数
+ 用户在每一个页面的停留时间

#### 4. 前端监控数据上报的方式

1. **直接发请求上报**

**存在问题**： 就是在页面卸载或刷新时进行上报的话，请求可能会在浏览器关闭或重新加载前还未发送至服务端就被浏览器 cancel 掉，导致数据上报失败。
**解决方式**：我们可以将 ajax 请求改为同步方法，这样就能保证请求一定能发送到服务端。由于 fetch 及 axios 都不支持同步请求，所以需要通过 XMLHttpRequest 发送同步请求。

2. **利用图片上报**

第二种方式就是利用图片的src属性发送请求进行数据上报，因为大部分浏览器会延迟卸载（unload）文档以加载图像（只是大多数浏览器，还是存在兼容性的），所以用图片上报就可以解决第一种方法的漏洞。

**优点**：

+ 图片请求方式不会出现**跨域**问题，因为打点域名经常不是当前域名；
+ 防止阻塞页面加载，影响用户体验；
+ 一般采用1*1像素的透明 gif 进行上报，因为gif图片格式体积小（最小的BMP文件需要74个字节，PNG需要67个字节，而合法的GIF，只需要43个字节）

**示例**：

`new Image().src = 'https://example.com/aaa?name=hester&num='+Math.random()` 

3. **`sendBeacon`**
同样为了解决页面卸载时，数据不能完成上报等问题，web底层新增了`sendBeacon`方法。

> 这个方法主要用于满足统计和诊断代码的需要，这些代码通常尝试在卸载（unload）文档之前向 Web 服务器发送数据。过早的发送数据可能导致错过收集数据的机会。然而，对于开发者来说保证在文档卸载期间发送数据一直是一个困难。

使用 `sendBeacon()` 方法会使用户代理（浏览器）在有机会时异步地向服务器发送数据，同时不会延迟页面的卸载或影响下一导航的载入性能，这意味着：

+ 数据发送是可靠的。
+ 数据异步传输。
+ 不影响下一个页面的载入。

**示例**：

`navigator.sendBeacon(url, data);`





